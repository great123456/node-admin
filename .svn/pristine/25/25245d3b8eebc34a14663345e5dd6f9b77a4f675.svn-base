/*! emomoBms 2017-02-10 */
var express=require("express"),router=express.Router(),fs=require("fs"),func=require("../core/func"),logger=require("../core/util/logger"),rest=require("../core/restUrl"),utils=require("../core/util/utils"),http=require("../core/util/http"),httpClient=require("../core/util/httpClient").DHttpUtil,sd=require("silly-datetime"),restFulPotion={host:rest.urls["emomo-yunkong"].host,port:rest.urls["emomo-yunkong"].port,postType:"json"},restFulConf=rest.urls["emomo-yunkong"],PAGE_SIZE=10;router.get("/page",function(a,b,c){restFulPotion.path=restFulConf.findBatchPage,params=a.query,searchKey=utils.filterParams(params,["batchName","batchNum"]),currentPage=""==params.currentPage?1:params.currentPage,restFulPotion.body=JSON.stringify({currentPage:currentPage,pageSize:PAGE_SIZE,keywords:searchKey}),http.doPost(restFulPotion,function(a,c){void 0!=c&&200==a?(c.PRO_MENU={menu:"device",subMenu:"batchPage"},b.render("batchPage",c)):b.render("order")})}),router.get("/add",function(a,b,c){data={},data.PRO_MENU={menu:"device",subMenu:"batchPage"},b.render("batchAddPage",data)}),router.post("/add",function(a,b,c){restFulPotion.path=restFulConf.addBatch,params=a.body,data={},data.batchName=params.batchName,data.batchNum=params.batchNum,restFulPotion.body=JSON.stringify(data),http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"batchPage"},utils.pageMessage(a,b,"添加成功","/batch/page","device","batchPage")):utils.pageMessage(a,b,d.mes,"/batch/page","device","batchPage")})}),router.post("/update",function(a,b,c){params=a.body,batchId=params.id,void 0!=batchId&&""!=batchId||utils.pageMessage(a,b,"请选择要更新的批次记录","/batch/page","device","batchPage"),data={},data.id=params.id,data.batchName=params.batchName,data.batchNum=params.batchNum,restFulPotion.body=JSON.stringify(data),restFulPotion.path=restFulConf.updateBatch,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"更新成功","/batch/page","device","batchPage"):utils.pageMessage(a,b,d.mes,"/batch/page","device","batchPage")})}),router.get("/update",function(a,b,c){params=a.query,batchId=params.batchId,console.log(batchId),void 0!=batchId&&""!=batchId||utils.pageMessage(a,b,"请选择要更新的批次记录","/batch/page","device","batchPage"),restFulPotion.path=restFulConf.findBatchById+batchId,http.doGet(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"batchPage"},b.render("batchUpdatePage",d)):utils.pageMessage(a,b,d.mes,"/batch/page","device","batchPage")})}),router.get("/share/page",function(a,b,c){restFulPotion.path=restFulConf.findBatchPage,params=a.query,searchKey=utils.filterParams(params,["batchName","batchNum"]),currentPage=""==params.currentPage?1:params.currentPage,restFulPotion.body=JSON.stringify({currentPage:currentPage,pageSize:PAGE_SIZE,keywords:searchKey}),http.doPost(restFulPotion,function(a,c){void 0!=c&&200==a?(c.PRO_MENU={menu:"sharePage",subMenu:"batchSharePage"},b.render("batchSharePage",c)):b.render("order")})}),router.get("/share/batchadd/page",function(a,b,c){var d={PRO_MENU:{menu:"sharePage",subMenu:"batchSharePage"}};b.render("batchShareAddPage",d)}),router.get("/setShare/page",function(a,b,c){console.log(" 批量设置分润");var d=a.query.batchNum;console.log("batchNum:"+d);var e={PRO_MENU:{menu:"sharePage",subMenu:"batchSharePage"},batchNum:d};b.render("deviceBatchShareSetPage",e)}),router.post("/share/set",function(a,b,c){console.log("设置分润比例");var d=a.body;restFulPotion.path=restFulConf.setBatchDeviceShare,restFulPotion.body=JSON.stringify(d),http.doPost(restFulPotion,function(a,c){void 0!=c&&200==a&&"0"==c.code?b.send(c):(func.error.mes=c.mes,b.send(func.error))})}),module.exports=router;