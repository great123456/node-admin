/*! emomoBms 2017-02-10 */
var express=require("express"),router=express.Router(),fs=require("fs"),func=require("../core/func"),logger=require("../core/util/logger"),rest=require("../core/restUrl"),utils=require("../core/util/utils"),http=require("../core/util/http"),httpClient=require("../core/util/httpClient").DHttpUtil,sd=require("silly-datetime"),async=require("async"),restFulPotion={host:rest.urls["emomo-yunkong"].host,port:rest.urls["emomo-yunkong"].port,postType:"json"},restFulConf=rest.urls["emomo-yunkong"],PAGE_SIZE=10;router.get("/page",function(a,b,c){var d=a.session.user.role;restFulPotion.path=restFulConf.proxyDevice,params=a.query,console.log(params);var e={};e=utils.filterParams(params,["deviceSn","regionName"]),e.isAllocationed="true"==params.isAllocationed,uid=a.session.user.uid,e.uid=uid,e.currentPage=""==params.currentPage?1:params.currentPage,e.pageSize=PAGE_SIZE,restFulPotion.body=JSON.stringify(e),console.log("---------searchKey-----------"),console.log(restFulPotion.body),http.doPost(restFulPotion,function(c,f){void 0!=f&&200==c&&"0"==f.code?(f.data.keywords=e,f.PRO_MENU={menu:"device",subMenu:"proxyDevice"},f.role=d,console.log("********"),console.log(JSON.stringify(f)),b.render("proxyDevicePage",f)):utils.pageMessage(a,b,f.mes,"/proxyDevice/page","device","proxyDevice")})}),router.post("/update",function(a,b,c){params=a.body,id=params.id,void 0!=id&&""!=id||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),console.log(params),data={},data.deviceSn=params.deviceSn,data.deviceName=params.deviceName,data.description=params.description,data.remark=params.remark,restFulPotion.body=JSON.stringify(data),restFulPotion.path=restFulConf.updateDevice,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"更新成功","/device/page","device","devicePage"):utils.pageMessage(a,b,d.mes,"/device/page","device","devicePage")})}),router.get("/update",function(a,b,c){params=a.query,id=params.id,void 0!=id&&""!=id||utils.pageMessage(a,b,"请选择要更新的设备","/proxyDevice/page","device","proxyDevice"),retrunData={};var d=[];d.push(function(a){restFulPotion.path=restFulConf.findDeviceById+id,http.doGet(restFulPotion,function(b,c){return void 0==c||200!=b||0!=c.code?void a("err",c):(retrunData.device=c.data,void a(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceRegionByNumber+retrunData.device.regionNumber,http.doGet(restParams,function(a,c){void 0!=c&&200==a&&"0"==c.code?(retrunData.deviceRegion=c.data,b(null,retrunData)):(retrunData.deviceRegion={},b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findBatchAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.batch=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceTypeAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.deviceType=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDevicePriceByDeviceSn+a.device.deviceSn,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.devicePrice=c.data,void b(null,retrunData))})}),async.waterfall(d,function(c,d){c?utils.pageMessage(a,b,c.mes,"/proxyDevice/page","device","proxyDevice"):(retrunData.PRO_MENU={menu:"device",subMenu:"proxyDevice"},b.render("proxyDeviceUpdatePage",retrunData))})}),router.post("/price/add",function(a,b,c){params=a.body,id=params.id,deviceSn=params.deviceSn,void 0!=id&&""!=id&&void 0!=deviceSn&&""!=deviceSn||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),data={},data.deviceSn=params.deviceSn,data.price=params.price,data.func=params.func,data.functionCmd=params.functionCmd,data.workTime=params.workTime,restFulPotion.body=JSON.stringify(data),restFulPotion.path=restFulConf.addDevicePrice,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"添加成功","/device/update?id="+id,"device","devicePage"):utils.pageMessage(a,b,d.mes,"/device/page","device","devicePage")})}),router.get("/price/add",function(a,b,c){params=a.query,sn=params.sn,void 0!=sn&&""!=sn||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),restFulPotion.path=restFulConf.findDeviceBySn+sn,http.doGet(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},b.render("devicePriceAddPage",d)):utils.pageMessage(a,b,d.msg,"/batch/page","device","devicePage")})}),router.post("/price/del",function(a,b,c){params=a.body,console.log(params),sn=params.deviceSn,id=params.priceId,deviceId=params.deviceId,void 0!=sn&&""!=sn&&void 0!=id&&""!=id&&void 0!=deviceId&&""!=deviceId||utils.pageMessage(a,b,"请选择要操作的设备","/device/page","device","devicePage"),restFulPotion.path=restFulConf.delDevicePrice+sn+"/"+id,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},utils.pageMessage(a,b,"删除成功","/device/update?id="+deviceId,"device","devicePage")):utils.pageMessage(a,b,d.msg,"/batch/page","device","devicePage")})}),router.post("/price/del",function(a,b,c){params=a.body,console.log(params),sn=params.deviceSn,id=params.priceId,deviceId=params.deviceId,void 0!=sn&&""!=sn&&void 0!=id&&""!=id&&void 0!=deviceId&&""!=deviceId||utils.pageMessage(a,b,"请选择要操作的设备","/device/page","device","devicePage"),restFulPotion.path=restFulConf.delDevicePrice+sn+"/"+id,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},utils.pageMessage(a,b,"删除成功","/device/update?id="+deviceId,"device","devicePage")):utils.pageMessage(a,b,d.msg,"/batch/page","device","devicePage")})}),router.post("/cmd",function(a,b,c){params=a.body,sn=params.deviceSn,cmd=params.cmd,void 0!=sn&&""!=sn&&void 0!=cmd&&""!=cmd||utils.pageMessage(a,b,"请选择要操作的设备","/device/page","device","devicePage"),callback=void 0==params.callback||""==params.callback?"device/page":params.callback,restFulPotion.path=restFulConf.cmdDevice+cmd+"/"+sn,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},utils.pageMessage(a,b,"操作成功",callback,"device","devicePage")):utils.pageMessage(a,b,d.msg,"/device/page","device","devicePage")})}),router.post("/bindRegion",function(a,b,c){params=a.body,deviceSns=params.deviceSns,void 0!=deviceSns&&""!=deviceSns||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),data={},data.deviceSns=params.deviceSns,data.regionNumber=params.regionNumber,restFulPotion.body=JSON.stringify(data),uid=a.session.user.uid,restFulPotion.path=restFulConf.bindDeviceRegion+uid,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"绑定成功","/proxyDevice/page","device","proxyDevice"):utils.pageMessage(a,b,d.mes,"/proxyDevic/page","device","proxyDevice")})}),router.post("/bindRegionPage",function(a,b,c){params=a.body,deviceSns=params.deviceSns,void 0!=deviceSns&&""!=deviceSns||utils.pageMessage(a,b,"请选择要分配的设备","/proxyDevice/page","device","proxyDevice"),retrunData={};var d=[];d.push(function(b){uid=a.session.user.uid,restParams=restFulPotion,restParams.path=restFulConf.deviceRegionAll+uid,http.doGet(restParams,function(a,c){return void 0==c||200!=a||0!=c.code?void b("err",c):(retrunData.deviceRegion=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceBySns,data={},data.deviceSns=deviceSns.split(","),restParams.body=JSON.stringify(data),http.doPost(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.devices=c.data,retrunData.deviceSns=deviceSns,b(null,retrunData),void 0)})}),async.waterfall(d,function(c,d){c?utils.pageMessage(a,b,c.msg,"/proxyDevice/page","device","proxyDevice"):(retrunData.PRO_MENU={menu:"device",subMenu:"proxyDevice"},b.render("deviceBindPage",retrunData))})}),router.post("/unbindRegion",function(a,b,c){params=a.body,deviceSn=params.deviceSn,void 0!=deviceSn&&""!=deviceSn||utils.pageMessage(a,b,"请选择要解绑的设备","/proxyDevice/page","device","proxyDevice"),uid=a.session.user.uid,restFulPotion.path=restFulConf.unbindDeviceRegion+uid+"/"+deviceSn,http.doPost(restFulPotion,function(c,d){callback=void 0==params.callback||""==params.callback?"proxyDevice/page":params.callback,void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"解绑成功",callback,"device","proxyDevice"):utils.pageMessage(a,b,d.mes,callback,"device","proxyDevice")})}),router.get("/bindSubProxyPage",function(a,b,c){params=a.query,deviceSns=params.deviceSns,void 0!=deviceSns&&""!=deviceSns||utils.pageMessage(a,b,"请选择要分配的设备","/proxyDevice/page","device","proxyDevice"),uid=a.session.user.uid,retrunData={};var d=[];d.push(function(a){var b={host:rest.urls["emomo-usersystem"].host,port:rest.urls["emomo-usersystem"].port,postType:"json"};b.path=rest.urls["emomo-usersystem"].findMyUsers,currentPage=""==params.currentPage?1:params.currentPage,b.body=JSON.stringify({currentPage:currentPage,pageSize:"300",uid:uid}),http.doPost(b,function(b,c){return void 0==c||200!=b?void a("err",c):(retrunData.subProxyAdmin=c.data,void a(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceBySns,data={},data.deviceSns=deviceSns.split(","),restParams.body=JSON.stringify(data),http.doPost(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.devices=c.data,retrunData.deviceSns=deviceSns,b(null,retrunData),void 0)})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.shareDeviceSubProxy+uid+"/"+deviceSns.split(","),http.doGet(restParams,function(a,c){if(void 0==c||200!=a||"0"!=c.code)return void b("err",c);tmpData={};for(var d=0;d<c.data.length;d++)tmpData[c.data[d].subProxyUserId]=c.data[d];retrunData.subProxyShare=tmpData,b(null,retrunData)})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.getDeviceShare+uid+"/"+deviceSns.split(","),http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.deviceShare=c.data,void b(null,retrunData))})}),async.waterfall(d,function(c,d){c?utils.pageMessage(a,b,c.msg,"/proxyDevice/page","device","proxyDevice"):(retrunData.PRO_MENU={menu:"device",subMenu:"proxyDevice"},b.render("deviceBindSubProxyPage",retrunData))})}),router.post("/bindSubProxy",function(a,b,c){if(params=a.body,console.log(params),deviceSns=params.deviceSns,void 0!=deviceSns&&""!=deviceSns||utils.pageMessage(a,b,"请选择要绑定的设备","/proxyDevice/page","device","proxyDevice"),data={},subProxys=[],console.log(" ffffffffffff  :"+typeof params.subProxyUserRate),"object"==typeof params.subProxyUserRate)for(var d=0;d<params.subProxyUserRate.length;d++)""!=params.subProxyUserRate[d]&&subProxys.push({subProxyUserId:params.subProxyUserId[d],subProxyUserRate:params.subProxyUserRate[d]});else""!=params.subProxyUserRate&&subProxys.push({subProxyUserId:params.subProxyUserId,subProxyUserRate:params.subProxyUserRate});data.subProxys=subProxys,data.subProxyUserAllRate=params.subProxyUserAllRate,uid=a.session.user.uid,restFulPotion.path=restFulConf.bindDeviceMoreSubProxy+uid+"/"+deviceSns.split(","),restFulPotion.body=JSON.stringify(data),http.doPost(restFulPotion,function(c,d){callback="/proxyDevice/bindSubProxyPage?deviceSns="+deviceSns,void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"操作成功",callback,"device","proxyDevice"):utils.pageMessage(a,b,d.mes,callback,"device","proxyDevice")})}),router.post("/unbindSubProxy",function(a,b,c){params=a.body,deviceSn=params.deviceSn,void 0!=deviceSn&&""!=deviceSn||utils.pageMessage(a,b,"请选择要解绑的设备","/proxyDevice/page","device","proxyDevice"),uid=a.session.user.uid,restFulPotion.path=restFulConf.unbindDeviceRegion+uid+"/"+deviceSn,http.doPost(restFulPotion,function(c,d){callback=void 0==params.callback||""==params.callback?"proxyDevice/page":params.callback,void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"解绑成功",callback,"device","proxyDevice"):utils.pageMessage(a,b,d.mes,callback,"device","proxyDevice")})}),module.exports=router;