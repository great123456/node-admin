/*! emomoBms 2017-02-10 */
function ajaxReturnData(a,b,c){return a=a||"-1",c=void 0==c?{}:c,b=b||"error",{code:a,data:c,mes:b}}function ajaxReturn(a,b,c,d){a.send(ajaxReturnData(b,c,d))}var express=require("express"),router=express.Router(),fs=require("fs"),func=require("../core/func"),logger=require("../core/util/logger"),rest=require("../core/restUrl"),http=require("../core/util/http"),httpClient=require("../core/util/httpClient").DHttpUtil,sd=require("silly-datetime"),utils=require("../core/util/utils"),restFulPotion={host:rest.urls["emomo-yunkong"].host,port:rest.urls["emomo-yunkong"].port,postType:"json"},restFulConf=rest.urls["emomo-yunkong"];router.get("/",function(a,b,c){b.render("login")}),router.get("/login",function(a,b,c){b.render("login")}),router.get("/login/admin",function(a,b,c){b.render("superLogin")}),router.post("/admin/dologin",function(a,b,c){var d=a.body;if(void 0==d.account||""==d.account)return void ajaxReturn(b,-1,"登录名不能为空");if(void 0==d.password||""==d.password)return void ajaxReturn(b,-1,"密码不能为空");data={account:d.account,password:d.password};var e={host:rest.urls["emomo-usersystem"].host,port:rest.urls["emomo-usersystem"].port,postType:"json"},f=rest.urls["emomo-usersystem"];e.path=f.adminlogin,e.body=JSON.stringify(data),http.doPost(e,function(c,d){return void 0!=d&&200==c&&0==d.code?(a.session.user={uid:d.data.uid,email:d.data.email,phone:d.data.phone,loginName:d.data.loginName,nickName:d.data.nickname,rolesId:1,role:"SUPER_ADMIN"},a.session.MEMBER_ROLE="SUPER_ADMIN",void ajaxReturn(b,1,"登录成功")):void ajaxReturn(b,-1,d.mes)})}),router.post("/login",function(a,b,c){var d=a.body;if(void 0==d.account||""==d.account)return void ajaxReturn(b,-1,"登录名不能为空");if(void 0==d.password||""==d.password)return void ajaxReturn(b,-1,"密码不能为空");data={account:d.account,password:d.password};var e={host:rest.urls["emomo-usersystem"].host,port:rest.urls["emomo-usersystem"].port,postType:"json"},f=rest.urls["emomo-usersystem"];e.path=f.login,e.body=JSON.stringify(data),http.doPost(e,function(c,d){return void 0!=d&&200==c&&0==d.code?(a.session.user={uid:d.data.userReg.uid,email:d.data.userReg.email,phone:d.data.userReg.phone,loginName:d.data.userInfo.loginName,nickName:d.data.userInfo.nickname,rolesId:d.data.roles[0].id,role:d.data.roles[0].role},a.session.MEMBER_ROLE=d.data.roles[0].role,void ajaxReturn(b,1,"登录成功")):void ajaxReturn(b,-1,d.mes)})}),router.get("/updatePassword",function(a,b,c){data={},data.PRO_MENU={menu:"member",subMenu:"updatePassword"},b.render("updatePassword",data)}),router.post("/updatePassword",function(a,b,c){params=a.body,oldpwd=params.oldpwd,void 0!=oldpwd&&""!=oldpwd||utils.pageMessage(a,b,"旧密码不能为空","/member/updatePassword","member","updatePassword"),newpwd=params.newpwd,void 0!=newpwd&&""!=newpwd||utils.pageMessage(a,b,"新密码不能为空","/member/updatePassword","member","updatePassword"),newpwd!=params.renewpwd&&utils.pageMessage(a,b,"确认密码出错","/member/updatePassword","member","updatePassword"),data={phone:a.session.user.phone,oldpwd:oldpwd,newpwd:newpwd};var d={host:rest.urls["emomo-usersystem"].host,port:rest.urls["emomo-usersystem"].port,postType:"json"},e=rest.urls["emomo-usersystem"];d.path=e.updatePassword,d.body=JSON.stringify(data),http.doPost(d,function(c,d){void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"修改成功","/member/updatePassword","member","updatePassword"):utils.pageMessage(a,b,d.mes,"/member/updatePassword","member","updatePassword")})}),router.get("/logout",function(a,b,c){a.session.destroy(),b.render("login")}),module.exports=router;