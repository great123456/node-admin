/*! emomoBms 2017-02-10 */
var express=require("express"),router=express.Router(),fs=require("fs"),func=require("../core/func"),logger=require("../core/util/logger"),rest=require("../core/restUrl"),http=require("../core/util/http"),httpClient=require("../core/util/httpClient").DHttpUtil,sd=require("silly-datetime"),utils=require("../core/util/utils"),restFulPotion={host:rest.urls["emomo-yunkong"].host,port:rest.urls["emomo-yunkong"].port,postType:"json"},restFulConf=rest.urls["emomo-yunkong"],PAGE_SIZE=10;router.get("/page",function(a,b,c){var d=a.session.user.role;restFulPotion.path=restFulConf.findDeviceRegionByPage,console.log("----------------------"),params=a.query,searchKey={},""!=params.number&&(searchKey.number=params.number),""!=params.name&&(searchKey.name=params.name),uid=a.session.user.uid,searchKey.ownerId=uid,currentPage=""==params.currentPage?1:params.currentPage,restFulPotion.body=JSON.stringify({currentPage:currentPage,pageSize:PAGE_SIZE,keywords:searchKey}),http.doPost(restFulPotion,function(a,c){console.log("----------------------"),void 0!=c&&200==a?(c.PRO_MENU={menu:"device",subMenu:"deviceRegionPage"},"INDUSTRY_AGENT"==d&&(c.PRO_MENU={menu:"address",subMenu:"myAddress"}),c.role=d,console.log(c),console.log(c.data.list[0]),b.render("deviceRegionPage",c)):b.render("order")})}),router.get("/add",function(a,b,c){var d=a.session.user.role;data={},data.PRO_MENU={menu:"device",subMenu:"deviceRegionPage"},"INDUSTRY_AGENT"==d&&(data.PRO_MENU={menu:"address",subMenu:"addAddress"}),data.role=d,b.render("deviceRegionAddPage",data)}),router.post("/add",function(a,b,c){var d=a.session.user.role;restFulPotion.path=restFulConf.addDeviceRegion,params=a.body,data={},data.number=params.number,data.name=params.name,data.description=params.desc,data.address=params.address,data.latitude=params.latitude,data.longitude=params.longitude,data.townName=params.city,imgUrl="";for(var e=0;e<params.img.length;e++)imgUrl+=params.img[e]+",";data.imgUrl=imgUrl,""==data.townName&&("INDUSTRY_AGENT"==d?utils.pageMessage(a,b,"请选择场所的地址","/deviceRegion/add","address","addAddress"):utils.pageMessage(a,b,"请选择场所的地址","/deviceRegion/add","device","deviceRegionAddPage")),uid=a.session.user.uid,data.ownerName=a.session.user.loginName,data.ownerId=uid,restFulPotion.body=JSON.stringify(data),http.doPost(restFulPotion,function(c,e){void 0!=e&&200==c&&0==e.code?"INDUSTRY_AGENT"==d?utils.pageMessage(a,b,"添加成功","/deviceRegion/page","address","addAddress"):utils.pageMessage(a,b,"添加成功","/deviceRegion/page","device","deviceRegionPage"):"INDUSTRY_AGENT"==d?utils.pageMessage(a,b,e.mes,"/deviceRegion/add","address","addAddress"):utils.pageMessage(a,b,e.mes,"/deviceRegion/add","device","deviceRegionPage")})}),router.get("/update",function(a,b,c){var d=a.session.user.role;params=a.query,id=params.id,callback=void 0==params.callback||""==params.callback?"/deviceRegion/page":params.callback,void 0!=id&&""!=id||("INDUSTRY_AGENT"==d?utils.pageMessage(a,b,"请求异常",callback,"address","myAddress"):utils.pageMessage(a,b,"请求异常",callback,"device","deviceRegionPage")),restFulPotion.path=restFulConf.findDeviceRegionById+"/"+id,http.doGet(restFulPotion,function(c,e){void 0!=e&&200==c&&"0"==e.code?(e.PRO_MENU={menu:"device",subMenu:"deviceRegionPage"},"INDUSTRY_AGENT"==d&&(e.PRO_MENU={menu:"address",subMenu:"myAddress"}),b.render("deviceRegionUpdatePage",e)):"INDUSTRY_AGENT"==d?utils.pageMessage(a,b,e.mes,callback,"address","myAddress"):utils.pageMessage(a,b,e.mes,callback,"device","deviceRegionPage")})}),router.post("/update",function(a,b,c){var d=a.session.user.role;restFulPotion.path=restFulConf.updateDeviceRegion,params=a.body,data={},data.number=params.number,data.name=params.name,data.description=params.desc,data.address=params.address||params.oldAddress,data.latitude=params.latitude,data.longitude=params.longitude,data.townName=params.city,""==data.townName&&("INDUSTRY_AGENT"==d?utils.pageMessage(a,b,"请选择场所的地址","/deviceRegion/add","address","addAddress"):utils.pageMessage(a,b,"请选择场所的地址","/deviceRegion/add","device","deviceRegionAddPage")),imgUrl=params.img.join(","),data.imgUrl=imgUrl,uid=a.session.user.uid,data.ownerId=uid,restFulPotion.body=JSON.stringify(data),http.doPost(restFulPotion,function(c,e){mes="",void 0!=e&&200==c&&0==e.code?mes="修改成功":mes=e.mes,"INDUSTRY_AGENT"==d?utils.pageMessage(a,b,mes,"/deviceRegion/page","address","myAddress"):utils.pageMessage(a,b,mes,"/deviceRegion/page","device","deviceRegionPage")})}),router.get("/share/page",function(a,b,c){restFulPotion.path=restFulConf.findDeviceRegionByPage,params=a.query,searchKey={},""!=params.number&&(searchKey.number=params.number),""!=params.name&&(searchKey.name=params.name),uid=a.session.user.uid,searchKey.ownerId=uid,currentPage=""==params.currentPage?1:params.currentPage,restFulPotion.body=JSON.stringify({currentPage:currentPage,pageSize:PAGE_SIZE,keywords:searchKey}),http.doPost(restFulPotion,function(a,c){void 0!=c&&200==a?(c.PRO_MENU={menu:"subProxyAdminPage",subMenu:"subProxyAdminPage"},console.log(c),b.render("deviceRegionSharePage",c)):b.render("order")})}),router.get("/share/set/page",function(a,b,c){var d=a.query,e=d.id,f=d.errorMsg;f=void 0==f?"":f,1==f&&(f="分润比例设置失败"),uid=a.session.user.uid,retrunData={};var g={host:rest.urls["emomo-usersystem"].host,port:rest.urls["emomo-usersystem"].port,postType:"json"};g.path=rest.urls["emomo-usersystem"].findMyUsers,currentPage=""==d.currentPage?1:d.currentPage,g.body=JSON.stringify({currentPage:currentPage,pageSize:"300",uid:uid}),http.doPost(g,function(a,c){void 0!=c&&200==a?(retrunData.subProxyAdmin=c.data,retrunData.PRO_MENU={menu:"subProxyAdminPage",subMenu:"subProxyAdminPage"},retrunData.regionId=e,retrunData.errorMsg=f,console.log(JSON.stringify(retrunData)),b.render("deviceRegionBatchShareSetPage",retrunData)):b.render("index")})}),router.post("/setRegionBatchShare",function(a,b,c){logger.info("批量设置场所分润");var d=a.body,e=d.regionId,f=a.session.user.uid;restFulPotion.path=restFulConf.setDeviceRegionShare,restFulPotion.body=JSON.stringify({regionId:e,proxyUserUid:f,subProxyUserId:d.subProxyUserId,subProxyUserRate:d.subProxyUserRate}),http.doPost(restFulPotion,function(a,c){if("0"==c.code){var d="/deviceRegion/share/page";b.redirect(d)}else{var d="/deviceRegion/share/set/page?id="+e+"&errorMsg=1";b.redirect(d)}})}),router.get("/detail",function(a,b,c){var d=a.session.user.role;restFulPotion.path=restFulConf.deviceRegionDetail,params=a.query,console.log(params);var e={currentPage:""==params.currentPage?1:params.currentPage,pageSize:PAGE_SIZE,regionNum:params.number};restFulPotion.body=JSON.stringify(e),http.doPost(restFulPotion,function(c,f){void 0!=f&&200==c&&"0"==f.code?(f.data.keywords=e,f.PRO_MENU={menu:"device",subMenu:"deviceRegionPage"},"INDUSTRY_AGENT"==d&&(f.PRO_MENU={menu:"address",subMenu:"myAddress"}),console.log("************"),console.log(JSON.stringify(f)),console.log("************"),b.render("deviceRegionDetailPage",f)):"INDUSTRY_AGENT"==d?utils.pageMessage(a,b,f.mes,"/proxyDevice/page","address","myAddress"):utils.pageMessage(a,b,f.mes,"/proxyDevice/page","device","proxyDevice")})}),module.exports=router;