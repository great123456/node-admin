/*! emomoBms 2017-02-10 */
var express=require("express"),router=express.Router(),fs=require("fs"),func=require("../core/func"),logger=require("../core/util/logger"),rest=require("../core/restUrl"),utils=require("../core/util/utils"),http=require("../core/util/http"),httpClient=require("../core/util/httpClient").DHttpUtil,sd=require("silly-datetime"),async=require("async"),restFulPotion={host:rest.urls["emomo-yunkong"].host,port:rest.urls["emomo-yunkong"].port,postType:"json"},restFulConf=rest.urls["emomo-yunkong"],PAGE_SIZE=10;router.get("/page",function(a,b,c){params=a.query,searchKey={},uid=a.session.user.uid,searchKey.currentPage=""==params.currentPage?1:params.currentPage,searchKey.pageSize=PAGE_SIZE,restFulPotion.body=JSON.stringify(searchKey);var d=a.session.user.role;"CITY_OPERATOR"==d?restFulPotion.path=restFulConf.subProxyDevice+uid:"FACTORY_ADMIN"==d?restFulPotion.path=restFulConf.factoryDevice+uid:utils.pageMessage(a,b,"登录状态异常","/index","index",""),http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&"0"==d.code?(d.data.keywords=searchKey,d.PRO_MENU={menu:"device",subMenu:"roleDevicePage"},d.PAGEURL="/roleDevice/page",b.render("roleDevicePage",d)):utils.pageMessage(a,b,d.mes,"/roleDevice/page","device","roleDevicePage")})}),router.get("/device",function(a,b,c){params=a.query,id=params.id,void 0!=id&&""!=id||utils.pageMessage(a,b,"请选择要更新的设备","/roleDevice/page","device","roleDevicePage"),retrunData={};var d=[];d.push(function(a){restFulPotion.path=restFulConf.findDeviceById+id,http.doGet(restFulPotion,function(b,c){return void 0==c||200!=b||0!=c.code?void a("err",c):(retrunData.device=c.data,void a(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findBatchAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.batch=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceTypeAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.deviceType=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDevicePriceByDeviceSn+a.device.deviceSn,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.devicePrice=c.data,void b(null,retrunData))})}),async.waterfall(d,function(c,d){c?utils.pageMessage(a,b,c.msg,"/roleDevice/page","roleDevice","roleDevicePage"):(retrunData.PRO_MENU={menu:"device",subMenu:"roleDevicePage"},b.render("deviceInfoPage",retrunData))})}),module.exports=router;