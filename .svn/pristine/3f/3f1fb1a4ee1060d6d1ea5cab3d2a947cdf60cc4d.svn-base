/*! emomoBms 2017-02-10 */
var express=require("express"),router=express.Router(),fs=require("fs"),func=require("../core/func"),logger=require("../core/util/logger"),rest=require("../core/restUrl"),utils=require("../core/util/utils"),http=require("../core/util/http"),httpClient=require("../core/util/httpClient").DHttpUtil,sd=require("silly-datetime"),async=require("async"),restFulPotion={host:rest.urls["emomo-yunkong"].host,port:rest.urls["emomo-yunkong"].port,postType:"json"},restFulConf=rest.urls["emomo-yunkong"],PAGE_SIZE=10;router.get("/page",function(a,b,c){restFulPotion.path=restFulConf.findMyDevicePage,params=a.query,currentPage=""==params.currentPage?1:params.currentPage,restFulPotion.body=JSON.stringify({currentPage:currentPage,pageSize:PAGE_SIZE,deviceSn:params.deviceSn,deviceName:params.deviceName,deviceType:params.deviceType,shareStatus:params.shareStatus});var d=params.shareStatus;http.doPost(restFulPotion,function(c,e){void 0!=e&&200==c&&"0"==e.code?(e.PRO_MENU={menu:"device",subMenu:"devicePage"},e.keywords={shareStatus:d,deviceType:params.deviceType,deviceName:params.deviceName,deviceSn:params.deviceSn},b.render("devicePage",e)):utils.pageMessage(a,b,e.mes,"/device/page","device","devicePage")})}),router.get("/add",function(a,b,c){retrunData={};var d=[];d.push(function(a){restParams=restFulPotion,restParams.path=restFulConf.findBatchAll,http.doGet(restParams,function(b,c){return void 0==c||200!=b||"0"!=c.code?void a("err",c):(retrunData.batch=c.data,void a(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceTypeAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.deviceType=c.data,void b(null,retrunData))})}),async.waterfall(d,function(c,d){c?utils.pageMessage(a,b,c.msg,"/batch/page","device","batchPage"):(retrunData.PRO_MENU={menu:"device",subMenu:"devicePage"},b.render("deviceAddPage",retrunData))})}),router.post("/add",function(a,b,c){restFulPotion.path=restFulConf.addDevice,params=a.body,data={},data.deviceSn=params.deviceSn,data.deviceName=params.deviceName,data.deviceTypeId=params.deviceTypeId,data.batchNum=params.batchNum,data.description=params.description,data.remark=params.remark,restFulPotion.body=JSON.stringify(data),http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},utils.pageMessage(a,b,"添加成功","/device/page","device","devicePage")):utils.pageMessage(a,b,d.mes,"/device/page","device","devicePage")})}),router.post("/update",function(a,b,c){params=a.body,id=params.id,void 0!=id&&""!=id||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),console.log(params),data={},data.deviceSn=params.deviceSn,data.deviceName=params.deviceName,data.description=params.description,data.deviceTypeId=params.deviceTypeId,data.deviceType=params.deviceType,data.batchNum=params.batchNum,data.remark=params.remark,restFulPotion.body=JSON.stringify(data),restFulPotion.path=restFulConf.updateDevice,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"更新成功","/device/page","device","devicePage"):utils.pageMessage(a,b,d.mes,"/device/page","device","devicePage")})}),router.get("/update",function(a,b,c){params=a.query,id=params.id,void 0!=id&&""!=id||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),retrunData={};var d=[];d.push(function(a){restFulPotion.path=restFulConf.findDeviceById+id,http.doGet(restFulPotion,function(b,c){return void 0==c||200!=b||0!=c.code?void a("err",c):(retrunData.device=c.data,void a(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findBatchAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.batch=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceTypeAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.deviceType=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDevicePriceByDeviceSn+a.device.deviceSn,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.devicePrice=c.data,void b(null,retrunData))})}),async.waterfall(d,function(c,d){c?utils.pageMessage(a,b,c.msg,"/batch/page","device","devicePage"):(retrunData.PRO_MENU={menu:"device",subMenu:"devicePage"},b.render("deviceUpdatePage",retrunData))})}),router.post("/price/add",function(a,b,c){params=a.body,id=params.id,deviceSn=params.deviceSn,void 0!=id&&""!=id&&void 0!=deviceSn&&""!=deviceSn||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),data={},data.deviceSn=params.deviceSn,data.price=params.price,data.func=params.func,data.functionCmd=params.functionCmd,data.workTime=params.workTime,restFulPotion.body=JSON.stringify(data),restFulPotion.path=restFulConf.addDevicePrice,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"添加成功","/device/update?id="+id,"device","devicePage"):utils.pageMessage(a,b,d.mes,"/device/page","device","devicePage")})}),router.get("/price/add",function(a,b,c){params=a.query,sn=params.sn,void 0!=sn&&""!=sn||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),restFulPotion.path=restFulConf.findDeviceBySn+sn,http.doGet(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},b.render("devicePriceAddPage",d)):utils.pageMessage(a,b,d.msg,"/batch/page","device","devicePage")})}),router.post("/price/del",function(a,b,c){params=a.body,console.log(params),sn=params.deviceSn,id=params.priceId,deviceId=params.deviceId,void 0!=sn&&""!=sn&&void 0!=id&&""!=id&&void 0!=deviceId&&""!=deviceId||utils.pageMessage(a,b,"请选择要操作的设备","/device/page","device","devicePage"),restFulPotion.path=restFulConf.delDevicePrice+sn+"/"+id,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},utils.pageMessage(a,b,"删除成功","/device/update?id="+deviceId,"device","devicePage")):utils.pageMessage(a,b,d.msg,"/batch/page","device","devicePage")})}),router.post("/price/del",function(a,b,c){params=a.body,console.log(params),sn=params.deviceSn,id=params.priceId,deviceId=params.deviceId,void 0!=sn&&""!=sn&&void 0!=id&&""!=id&&void 0!=deviceId&&""!=deviceId||utils.pageMessage(a,b,"请选择要操作的设备","/device/page","device","devicePage"),restFulPotion.path=restFulConf.delDevicePrice+sn+"/"+id,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},utils.pageMessage(a,b,"删除成功","/device/update?id="+deviceId,"device","devicePage")):utils.pageMessage(a,b,d.msg,"/batch/page","device","devicePage")})}),router.post("/cmd",function(a,b,c){params=a.body,sn=params.deviceSn,cmd=params.cmd,void 0!=sn&&""!=sn&&void 0!=cmd&&""!=cmd||utils.pageMessage(a,b,"请选择要操作的设备","/device/page","device","devicePage"),callback=void 0==params.callback||""==params.callback?"device/page":params.callback,restFulPotion.path=restFulConf.cmdDevice+cmd+"/"+sn,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?(d.PRO_MENU={menu:"device",subMenu:"devicePage"},utils.pageMessage(a,b,"操作成功",callback,"device","devicePage")):utils.pageMessage(a,b,d.msg,"/device/page","device","devicePage")})}),router.post("/allocation",function(a,b,c){params=a.body,deviceSns=params.deviceSns,void 0!=deviceSns&&""!=deviceSns||utils.pageMessage(a,b,"请选择要更新的设备","/device/page","device","devicePage"),data={},data.deviceSns=params.deviceSns,data.typeNum=params.typeNum,data.batchNum=params.batchNum,data.regionProxyUserId=params.regionProxyUserId,uid=a.session.user.uid,data.platformUserId=uid,restFulPotion.body=JSON.stringify(data),restFulPotion.path=restFulConf.allocationDevice,http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&0==d.code?utils.pageMessage(a,b,"分配成功","/device/page","device","devicePage"):utils.pageMessage(a,b,d.mes,"/device/page","device","devicePage")})}),router.post("/allocationPage",function(a,b,c){params=a.body,deviceSns=params.deviceSns,void 0!=deviceSns&&""!=deviceSns||utils.pageMessage(a,b,"请选择要分配的设备","/device/page","device","devicePage"),retrunData={};var d=[];d.push(function(a){var b={host:rest.urls["emomo-usersystem"].host,port:rest.urls["emomo-usersystem"].port,postType:"json"};b.path=rest.urls["emomo-usersystem"].allUserByRole+"/INDUSTRY_AGENT",http.doGet(b,function(b,c){return void 0==c||200!=b||0!=c.code?void a("err",c):(retrunData.proxyAdmin=c.data,void a(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceTypeAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.deviceType=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findBatchAll,http.doGet(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.batch=c.data,void b(null,retrunData))})}),d.push(function(a,b){restParams=restFulPotion,restParams.path=restFulConf.findDeviceBySns,data={},data.deviceSns=deviceSns.split(","),restParams.body=JSON.stringify(data),http.doPost(restParams,function(a,c){return void 0==c||200!=a||"0"!=c.code?void b("err",c):(retrunData.devices=c.data,retrunData.deviceSns=deviceSns,b(null,retrunData),void 0)})}),async.waterfall(d,function(c,d){c?utils.pageMessage(a,b,c.mes,"/batch/page","device","devicePage"):(retrunData.PRO_MENU={menu:"device",subMenu:"devicePage"},b.render("deviceAllocationPage",retrunData))})}),router.get("/batch/add",function(a,b,c){var d={PRO_MENU:{menu:"device",subMenu:"devicePage"}};b.render("deviceBatchAddPage",d)}),router.get("/share/page",function(a,b,c){restFulPotion.path=restFulConf.findMyDevicePage,params=a.query,currentPage=""==params.currentPage?1:params.currentPage,restFulPotion.body=JSON.stringify({currentPage:currentPage,pageSize:PAGE_SIZE,deviceSn:params.deviceSn,deviceName:params.deviceName,deviceType:params.deviceType,shareStatus:0}),http.doPost(restFulPotion,function(c,d){void 0!=d&&200==c&&"0"==d.code?(d.PRO_MENU={menu:"sharePage",subMenu:"batchSharePage"},d.keywords={shareStatus:0,deviceType:params.deviceType,deviceName:params.deviceName,deviceSn:params.deviceSn},b.render("deviceSharePage",d)):utils.pageMessage(a,b,d.mes,"/device/page","device","devicePage")})}),router.post("/delete/bind",function(a,b,c){console.log("解除绑定");var d=a.body.deviceSn;console.log("deviceSn:"+d),restParams=restFulPotion,restParams.path=restFulConf.deleteBindDevice+d,http.doGet(restParams,function(a,c){"0"==c.code?b.send(c):(func.error.data=c.mes,b.send(func.error))})}),router.get("/single/setShare/page",function(a,b,c){console.log("单个设置分润");var d=a.query.deviceSn;console.log("deviceSn:"+d);var e={PRO_MENU:{menu:"sharePage",subMenu:"batchSharePage"},deviceSn:d};b.render("deviceSingleShareSetPage",e)}),router.post("/single/share/set",function(a,b,c){console.log("设置分润比例");var d=a.body;restFulPotion.path=restFulConf.setSingleDeviceShare,restFulPotion.body=JSON.stringify(d),http.doPost(restFulPotion,function(a,c){void 0!=c&&200==a&&"0"==c.code?b.send(c):(func.error.mes=c.mes,b.send(func.error))})}),module.exports=router;